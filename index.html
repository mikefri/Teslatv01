<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeslaTV</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
    <!-- Google Cast -->
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #151b2b;
            --bg-tertiary: #1e2738;
            --accent: #00d9ff;
            --accent-glow: rgba(0, 217, 255, 0.3);
            --text-primary: #ffffff;
            --text-secondary: #8b93a7;
            --border: rgba(255, 255, 255, 0.1);
            --shadow: rgba(0, 0, 0, 0.5);
            --fav-gold: #ffb700;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        /* Focus visible pour la t√©l√©commande */
        :focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden; /* App style */
            height: 100vh;
        }

        /* --- SIDEBAR (Menu) --- */
        .sidebar-toggle {
            position: fixed; left: 0; top: 50%; transform: translateY(-50%);
            width: 50px; height: 120px;
            background: var(--bg-tertiary); border: 1px solid var(--border);
            border-left: none; border-radius: 0 16px 16px 0; cursor: pointer; z-index: 1001;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease; box-shadow: 4px 0 20px rgba(0,0,0,0.5);
        }
        .sidebar-toggle:hover { width: 60px; background: var(--accent); color: #000; }
        .sidebar-toggle.open { left: 400px; }
        .sidebar-toggle svg { width: 24px; fill: currentColor; }

        .sidebar {
            position: fixed; left: -400px; top: 0; width: 400px; height: 100vh;
            background: var(--bg-secondary); border-right: 1px solid var(--border);
            z-index: 1000; transition: left 0.3s ease; display: flex; flex-direction: column;
        }
        .sidebar.open { left: 0; }

        .sidebar-header { padding: 1.5rem; background: var(--bg-tertiary); border-bottom: 1px solid var(--border); }
        .sidebar-title { font-family: 'Syne', sans-serif; font-size: 2rem; font-weight: 800; cursor: pointer; background: linear-gradient(90deg, #fff, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .mode-switcher { display: flex; gap: 5px; margin-top: 1rem; }
        .mode-btn { flex: 1; padding: 10px; background: rgba(255,255,255,0.05); border: none; color: var(--text-secondary); border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .mode-btn.active { background: var(--accent); color: #000; }

        .search-container { padding: 1rem; }
        .search-box { width: 100%; padding: 12px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 12px; color: white; font-size: 1rem; }
        
        .channels-grid { flex: 1; overflow-y: auto; padding: 0 1rem 1rem 1rem; }
        .channel-card {
            display: flex; align-items: center; gap: 1rem; padding: 12px;
            background: var(--bg-primary); border: 1px solid var(--border);
            border-radius: 12px; margin-bottom: 8px; cursor: pointer;
            transition: all 0.2s;
        }
        .channel-card:hover, .channel-card.focused { transform: translateX(5px); border-color: var(--accent); background: var(--bg-tertiary); }
        .channel-card.active { border-color: var(--accent); background: linear-gradient(90deg, rgba(0,217,255,0.1), transparent); }
        .channel-logo { width: 40px; height: 40px; object-fit: contain; background: rgba(255,255,255,0.1); border-radius: 8px; padding: 4px; }

        /* --- MAIN PLAYER AREA --- */
        .main-content { transition: margin-left 0.3s; height: 100vh; padding: 2rem; display: flex; flex-direction: column; }
        .main-content.shifted { margin-left: 400px; }
        
        .container { max-width: 1600px; margin: 0 auto; width: 100%; height: 100%; display: flex; flex-direction: column; }
        
        /* LE CADRE DU PLAYER (Le design que tu aimes) */
        .player-frame {
            background: var(--bg-secondary); border-radius: 24px; 
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px var(--shadow), 0 0 0 1px rgba(255,255,255,0.05);
            display: flex; flex-direction: column; overflow: hidden;
            flex: 1; position: relative;
        }

        /* En-t√™te du Player */
        .player-header {
            padding: 1rem 2rem; background: linear-gradient(180deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;
        }
        .header-info { display: flex; align-items: center; gap: 1rem; }
        .header-controls { display: flex; gap: 0.5rem; }
        
        .ctrl-btn {
            width: 40px; height: 40px; border-radius: 10px; border: 1px solid var(--border);
            background: var(--bg-primary); color: var(--text-secondary); cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .ctrl-btn:hover { background: var(--accent); color: #000; border-color: var(--accent); }
        .ctrl-btn svg { width: 20px; height: 20px; fill: currentColor; }

        /* Zone Vid√©o */
        .video-wrapper { 
            position: relative; flex: 1; background: #000; 
            display: flex; align-items: center; justify-content: center; 
        }
        
        #videoPlayer, #iframePlayer { width: 100%; height: 100%; }
        #iframePlayer { display: none; border: none; }

        /* BOUTONS DE ZAPPING (Sur la vid√©o) */
        .zap-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; justify-content: space-between; align-items: center; z-index: 10;
        }
        .zap-zone {
            width: 15%; height: 60%; pointer-events: auto; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s; border-radius: 12px;
        }
        .zap-zone:hover { opacity: 1; background: linear-gradient(90deg, rgba(0,0,0,0.6) 0%, transparent 100%); }
        .zap-zone.next:hover { background: linear-gradient(-90deg, rgba(0,0,0,0.6) 0%, transparent 100%); }
        .zap-zone svg { width: 50px; height: 50px; fill: white; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.8)); }

        /* Loader & Overlay */
        .loader {
            position: absolute; inset: 0; background: rgba(0,0,0,0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 5; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .loader.active { opacity: 1; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { width: 100%; }
            .sidebar-toggle.open { left: auto; right: 0; }
            .main-content { padding: 0; }
            .main-content.shifted { margin-left: 0; }
            .player-frame { border-radius: 0; border: none; }
            .zap-zone { width: 20%; }
        }
    </style>
</head>
<body>

    <!-- BOUTON MENU FLOTTANT -->
    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
        <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
    </button>

    <!-- MENU SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title" onclick="unlockSecret()">TeslaTV</div>
            <div class="mode-switcher">
                <button class="mode-btn active" onclick="switchMode('tv')">TV</button>
                <button class="mode-btn" onclick="switchMode('series')">S√©ries</button>
                <button id="xxxBtn" class="mode-btn" style="display:none; color:#ff0040;" onclick="switchMode('xxx')">18+</button>
            </div>
        </div>
        <div class="search-container">
            <input type="text" class="search-box" id="searchInput" placeholder="Rechercher une cha√Æne...">
        </div>
        <div class="channels-grid" id="grid">
            <!-- Liste g√©n√©r√©e par JS -->
        </div>
    </div>

    <!-- CONTENU PRINCIPAL -->
    <div class="main-content" id="mainContent">
        <div class="container">
            <!-- CADRE DU LECTEUR -->
            <div class="player-frame" id="playerContainer">
                
                <!-- EN-T√äTE DU PLAYER -->
                <div class="player-header">
                    <div class="header-info">
                        <img src="" id="currentLogo" style="height:30px; display:none;">
                        <div>
                            <h2 id="currentTitle" style="font-size:1.2rem; margin:0;">Bienvenue</h2>
                            <p id="currentCat" style="font-size:0.8rem; color:var(--text-secondary); margin:0;">S√©lectionnez un contenu</p>
                        </div>
                    </div>
                    <div class="header-controls">
                        <button class="ctrl-btn" onclick="toggleFav()" title="Favoris">
                            <svg id="favIcon" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        </button>
                        <button class="ctrl-btn" onclick="togglePiP()" title="Picture in Picture">
                            <svg viewBox="0 0 24 24"><path d="M19 11h-8v6h8v-6zm4 8V4.98C23 3.88 22.1 3 21 3H3c-1.1 0-2 .88-2 1.98V19c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2zm-2 .02H3V4.97h18v14.05z"/></svg>
                        </button>
                        <button class="ctrl-btn" onclick="toggleFullscreen()" title="Plein √âcran">
                            <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
                        </button>
                        <button class="ctrl-btn" onclick="toggleCast()" title="Caster">
                            <svg viewBox="0 0 24 24"><path d="M1 18v3h3c0-1.66-1.34-3-3-3zm0-4v2c2.76 0 5 2.24 5 5h2c0-3.87-3.13-7-7-7zm0-4v2c4.97 0 9 4.03 9 9h2c0-6.08-4.93-11-11-11zm20-7H3c-1.1 0-2 .9-2 2v3h2V5h18v14h-7v2h7c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
                        </button>
                    </div>
                </div>

                <!-- ZONE VIDEO -->
                <div class="video-wrapper">
                    <!-- Boutons de Zapping -->
                    <div class="zap-overlay">
                        <div class="zap-zone prev" onclick="zap(-1)" title="Cha√Æne Pr√©c√©dente (Fl√®che Gauche)">
                            <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                        </div>
                        <div class="zap-zone next" onclick="zap(1)" title="Cha√Æne Suivante (Fl√®che Droite)">
                            <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                        </div>
                    </div>

                    <div class="loader" id="loader"><div class="spinner"></div></div>

                    <video id="videoPlayer" controls autoplay playsinline crossorigin="anonymous"></video>
                    <iframe id="iframePlayer" allowfullscreen allow="autoplay"></iframe>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const URLS = {
            tv: 'https://gist.githubusercontent.com/mikefri/0802a5afa97ac99a27cec4e6c1737a95/raw/channels.json',
            series: 'https://gist.githubusercontent.com/mikefri/d914d7a8684d5f4900890bc41d9c223c/raw/series.json',
            xxx: 'https://gist.githubusercontent.com/mikefri/c4ea8003ac647eeafd14c35db59431ea/raw/xx.json'
        };

        // √âTAT
        let state = {
            mode: localStorage.getItem('mode') || 'tv',
            list: [],
            current: null,
            favs: JSON.parse(localStorage.getItem('favs')) || [],
            focusIdx: -1
        };
        let hlsPlayer = null;
        let dashPlayer = null;

        // ELEMENTS
        const ui = {
            sidebar: document.getElementById('sidebar'),
            grid: document.getElementById('grid'),
            video: document.getElementById('videoPlayer'),
            iframe: document.getElementById('iframePlayer'),
            loader: document.getElementById('loader'),
            container: document.getElementById('playerContainer'),
            search: document.getElementById('searchInput')
        };

        // --- INITIALISATION ---
        async function init() {
            switchMode(state.mode);
            
            // √âv√©nements
            ui.search.addEventListener('input', render);
            
            // Gestion T√©l√©commande / Clavier
            document.addEventListener('keydown', handleKeys);

            // Gestion Vid√©o
            ui.video.addEventListener('waiting', () => ui.loader.classList.add('active'));
            ui.video.addEventListener('playing', () => ui.loader.classList.remove('active'));

            // Auto-ouverture PC
            if(window.innerWidth > 1000) toggleSidebar();
        }

        // --- LOGIQUE CLAVIER / T√âL√âCOMMANDE ---
        function handleKeys(e) {
            const isMenuOpen = ui.sidebar.classList.contains('open');

            // Touches Globales
            if(e.key === 'm' || e.key === 'M') toggleSidebar();
            if(e.key === 'f' || e.key === 'F') toggleFullscreen();

            if (isMenuOpen) {
                // Navigation Menu
                const cards = document.querySelectorAll('.channel-card');
                if(e.key === 'ArrowDown') {
                    e.preventDefault();
                    state.focusIdx = Math.min(state.focusIdx + 1, cards.length - 1);
                    focusCard(cards);
                } else if(e.key === 'ArrowUp') {
                    e.preventDefault();
                    state.focusIdx = Math.max(state.focusIdx - 1, 0);
                    focusCard(cards);
                } else if(e.key === 'Enter') {
                    if(state.focusIdx >= 0) cards[state.focusIdx].click();
                } else if(e.key === 'ArrowRight' || e.key === 'Escape') {
                    toggleSidebar();
                }
            } else {
                // Navigation Vid√©o (Zapping)
                if(e.key === 'ArrowRight') zap(1);
                else if(e.key === 'ArrowLeft') zap(-1);
                else if(e.key === 'Enter' || e.key === 'ArrowUp') toggleSidebar();
            }
        }

        function focusCard(cards) {
            cards.forEach(c => c.classList.remove('focused'));
            if(cards[state.focusIdx]) {
                cards[state.focusIdx].classList.add('focused');
                cards[state.focusIdx].scrollIntoView({block: 'center'});
            }
        }

        // --- ZAPPING ---
        function zap(dir) {
            if(!state.current) return toggleSidebar();
            
            // On zappe uniquement dans la liste filtr√©e visible
            const visibleList = getFilteredList();
            if(visibleList.length === 0) return;

            const idx = visibleList.findIndex(c => c.id === state.current.id);
            if(idx === -1) return;

            let next = idx + dir;
            if(next >= visibleList.length) next = 0;
            if(next < 0) next = visibleList.length - 1;

            play(visibleList[next].id);
        }

        function getFilteredList() {
            const term = ui.search.value.toLowerCase();
            return state.list.filter(i => i.name.toLowerCase().includes(term));
        }

        // --- FONCTIONS PRINCIPALES ---
        async function switchMode(mode) {
            state.mode = mode;
            state.focusIdx = -1;
            localStorage.setItem('mode', mode);
            
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.mode-btn[onclick="switchMode('${mode}')"]`)?.classList.add('active');
            
            ui.grid.innerHTML = '<div style="text-align:center; padding:20px;">Chargement...</div>';
            
            try {
                const res = await fetch(URLS[mode] + '?t=' + Date.now());
                state.list = await res.json();
                render();
            } catch(e) {
                ui.grid.innerHTML = '<div style="color:red; text-align:center;">Erreur chargement</div>';
            }
        }

        function render() {
            const list = getFilteredList();
            
            // Tri: Favoris en premier
            list.sort((a, b) => {
                const aFav = state.favs.includes(a.id);
                const bFav = state.favs.includes(b.id);
                if (aFav && !bFav) return -1;
                if (!aFav && bFav) return 1;
                return 0;
            });

            ui.grid.innerHTML = list.map(item => `
                <div class="channel-card ${state.current?.id === item.id ? 'active' : ''}" onclick="play(${item.id})">
                    <img src="${item.logo || 'https://i.imgur.com/QxHt9NC.png'}" class="channel-logo" loading="lazy">
                    <div style="flex:1">
                        <div style="font-weight:600">${item.name}</div>
                        <div style="font-size:0.8rem; color:var(--text-secondary)">${item.category}</div>
                    </div>
                    ${state.favs.includes(item.id) ? '<span style="color:var(--fav-gold)">‚òÖ</span>' : ''}
                </div>
            `).join('');
        }

        function play(id) {
            const item = state.list.find(i => i.id === id);
            if(!item) return;

            state.current = item;
            render(); // MAJ visuelle active

            // UI
            document.getElementById('currentTitle').textContent = item.name;
            document.getElementById('currentCat').textContent = item.category;
            const logo = document.getElementById('currentLogo');
            logo.src = item.logo || '';
            logo.style.display = 'block';
            updateFavIcon();

            // Reset
            ui.loader.classList.add('active');
            if(hlsPlayer) { hlsPlayer.destroy(); hlsPlayer = null; }
            if(dashPlayer) { dashPlayer.reset(); dashPlayer = null; }
            ui.video.style.display = 'none';
            ui.iframe.style.display = 'none';
            ui.iframe.src = '';
            ui.video.pause();

            // Lecture
            const url = item.url;
            if(url.includes('mega.nz') || !url.match(/\.(m3u8|mpd|mp4)$/)) {
                ui.iframe.src = url.includes('mega.nz') ? url.replace('/file/', '/embed/') : url;
                ui.iframe.style.display = 'block';
                ui.loader.classList.remove('active');
            } else {
                ui.video.style.display = 'block';
                if(Hls.isSupported() && url.endsWith('.m3u8')) {
                    hlsPlayer = new Hls();
                    hlsPlayer.loadSource(url);
                    hlsPlayer.attachMedia(ui.video);
                    hlsPlayer.on(Hls.Events.MANIFEST_PARSED, () => ui.video.play());
                } else if(typeof dashjs !== 'undefined' && url.endsWith('.mpd')) {
                    dashPlayer = dashjs.MediaPlayer().create();
                    dashPlayer.initialize(ui.video, url, true);
                } else {
                    ui.video.src = url;
                    ui.video.play();
                }
            }

            // Fermer menu sur mobile
            if(window.innerWidth < 1000) toggleSidebar();
        }

        // --- OUTILS ---
        function toggleSidebar() {
            ui.sidebar.classList.toggle('open');
            document.getElementById('sidebarToggle').classList.toggle('open');
            document.getElementById('mainContent').classList.toggle('shifted');
            if(ui.sidebar.classList.contains('open')) {
                state.focusIdx = 0;
                ui.search.focus();
            }
        }

        function toggleFullscreen() {
            // Astuce: On met le CONTAINER (Cadre) en plein √©cran, pas juste la vid√©o
            // Cela garde les boutons de zapping et le titre visibles !
            if (!document.fullscreenElement) {
                ui.container.requestFullscreen().catch(err => {
                    alert("Erreur plein √©cran: " + err.message);
                });
            } else {
                document.exitFullscreen();
            }
        }

        function toggleFav() {
            if(!state.current) return;
            const id = state.current.id;
            if(state.favs.includes(id)) state.favs = state.favs.filter(f => f !== id);
            else state.favs.push(id);
            localStorage.setItem('favs', JSON.stringify(state.favs));
            render();
            updateFavIcon();
        }

        function updateFavIcon() {
            const icon = document.getElementById('favIcon');
            if(state.current && state.favs.includes(state.current.id)) icon.style.fill = 'var(--fav-gold)';
            else icon.style.fill = 'currentColor';
        }

        function togglePiP() {
            if(document.pictureInPictureElement) document.exitPictureInPicture();
            else if(ui.video.readyState >= 3) ui.video.requestPictureInPicture();
        }

        // Secret
        let sc=0;
        function unlockSecret() {
            sc++;
            if(sc===5) { document.getElementById('xxxBtn').style.display='block'; alert('üîû'); }
            setTimeout(()=>sc=0, 2000);
        }

        // Cast (Placeholder)
        function toggleCast() {
            try { cast.framework.CastContext.getInstance().requestSession(); } catch(e) { alert("Cast non dispo"); }
        }
        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) cast.framework.CastContext.getInstance().setOptions({receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID});
        };

        init();
    </script>
</body>
</html>
