<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeslaTV - Cast & Record</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
    <!-- Google Cast SDK -->
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #151b2b;
            --bg-tertiary: #1e2738;
            --accent: #00d9ff;
            --accent-glow: rgba(0, 217, 255, 0.3);
            --text-primary: #ffffff;
            --text-secondary: #8b93a7;
            --border: rgba(255, 255, 255, 0.08);
            --shadow: rgba(0, 0, 0, 0.4);
            --rec-red: #ff0040;
            --cast-blue: #4285f4;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }

        /* Sidebar Toggle Button */
        .sidebar-toggle {
            position: fixed; left: 0; top: 50%; transform: translateY(-50%);
            width: 50px; height: 120px;
            background: linear-gradient(135deg, var(--accent) 0%, #0099cc 100%);
            border: none; border-radius: 0 16px 16px 0; cursor: pointer; z-index: 1001;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 4px 0 20px rgba(0, 217, 255, 0.3); transition: all 0.3s ease;
        }
        .sidebar-toggle:hover { width: 60px; box-shadow: 6px 0 30px rgba(0, 217, 255, 0.5); }
        .sidebar-toggle.open { left: 450px; }
        .sidebar-toggle svg { width: 24px; height: 24px; fill: white; transition: transform 0.3s ease; }
        .sidebar-toggle.open svg { transform: rotate(180deg); }

        /* Sidebar */
        .sidebar {
            position: fixed; left: -450px; top: 0;
            width: 450px; height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            z-index: 1000;
            transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            box-shadow: 4px 0 30px rgba(0, 0, 0, 0.5);
            display: flex; flex-direction: column;
        }
        .sidebar.open { left: 0; }

        .sidebar-header {
            padding: 2rem 2rem 1rem 2rem;
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 10;
        }

        .sidebar-title {
            font-family: 'Syne', sans-serif; font-size: 1.8rem; font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #ffffff 0%, var(--accent) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            /* Curseur pour indiquer que c'est cliquable pour l'easter egg */
            cursor: pointer; user-select: none;
        }
        .sidebar-subtitle { color: var(--text-secondary); font-size: 0.9rem; font-weight: 500; }

        /* MODE SWITCHER */
        .mode-switcher {
            display: flex; background: var(--bg-primary); padding: 4px;
            border-radius: 12px; margin-top: 1.5rem; border: 1px solid var(--border);
            flex-wrap: wrap; gap: 2px;
        }
        .mode-btn {
            flex: 1; padding: 10px; border: none; background: transparent;
            color: var(--text-secondary); cursor: pointer; border-radius: 8px;
            font-family: 'Syne', sans-serif; font-weight: 600; font-size: 0.9rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .mode-btn:hover { color: var(--text-primary); }
        .mode-btn.active {
            background: var(--bg-tertiary); color: var(--accent);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .sidebar-filters {
            padding: 1.5rem; background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            position: sticky; top: 180px; z-index: 9;
        }

        .sidebar-content { padding: 1rem; flex: 1; }

        /* Main Content */
        .main-content { transition: margin-left 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .main-content.shifted { margin-left: 450px; }

        .sidebar-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); z-index: 999;
            opacity: 0; pointer-events: none;
            transition: opacity 0.4s ease; backdrop-filter: blur(4px);
        }
        .sidebar-overlay.active { opacity: 1; pointer-events: auto; }

        /* Background */
        body::before {
            content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 20% 50%, rgba(0, 217, 255, 0.03) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(138, 43, 226, 0.03) 0%, transparent 50%);
            animation: bgFloat 20s ease-in-out infinite; pointer-events: none; z-index: 0;
        }
        @keyframes bgFloat {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(-5%, 5%) rotate(5deg); }
        }

        .container { position: relative; z-index: 1; max-width: 1800px; margin: 0 auto; padding: 2rem; }
        header { margin-bottom: 2rem; animation: fadeInDown 0.8s ease-out; }
        h1 {
            font-family: 'Syne', sans-serif; font-size: 3.5rem; font-weight: 800;
            background: linear-gradient(135deg, #ffffff 0%, var(--accent) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            letter-spacing: -0.03em; margin-bottom: 0.5rem;
        }

        /* Player */
        .player-section { margin-bottom: 0; animation: fadeInUp 0.8s ease-out 0.2s backwards; }
        .player-container {
            position: relative; background: var(--bg-secondary); border-radius: 24px; overflow: hidden;
            box-shadow: 0 20px 60px var(--shadow), 0 0 0 1px var(--border), 0 0 40px var(--accent-glow);
        }
        .player-header {
            padding: 1.5rem 2rem; background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between;
            flex-wrap: wrap; gap: 1rem;
        }
        .now-playing { display: flex; align-items: center; gap: 1rem; }
        .channel-logo {
            width: 50px; height: 50px; object-fit: contain;
            background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 0.5rem;
        }
        .channel-info h2 { font-family: 'Syne', sans-serif; font-size: 1.4rem; font-weight: 700; margin-bottom: 0.25rem; }
        .channel-category { color: var(--text-secondary); font-size: 0.9rem; font-weight: 500; }
        
        .header-actions { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
        
        .live-indicator {
            display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem;
            background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.3); border-radius: 20px;
        }
        .live-dot { width: 8px; height: 8px; background: #ff0000; border-radius: 50%; animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .live-text { font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; }

        /* CAST BUTTON */
        .cast-button {
            position: relative;
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.75rem 1.25rem; border: none; border-radius: 12px;
            font-family: 'Syne', sans-serif; font-weight: 600; font-size: 0.9rem;
            cursor: pointer; transition: all 0.3s ease;
            background: var(--bg-tertiary); color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .cast-button:hover:not(.disabled) {
            background: var(--cast-blue);
            border-color: var(--cast-blue);
            box-shadow: 0 0 20px rgba(66, 133, 244, 0.4);
            color: white;
        }
        .cast-button.casting {
            background: var(--cast-blue);
            border-color: var(--cast-blue);
            color: white;
            animation: castPulse 2s ease-in-out infinite;
        }
        .cast-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        @keyframes castPulse {
            0%, 100% { box-shadow: 0 0 15px rgba(66, 133, 244, 0.4); }
            50% { box-shadow: 0 0 25px rgba(66, 133, 244, 0.7); }
        }
        .cast-icon {
            width: 20px; height: 20px;
            fill: currentColor;
        }

        /* RECORDING BUTTON */
        .rec-button {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.75rem 1.25rem; border: none; border-radius: 12px;
            font-family: 'Syne', sans-serif; font-weight: 600; font-size: 0.9rem;
            cursor: pointer; transition: all 0.3s ease;
            background: var(--bg-tertiary); color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .rec-button:hover:not(.disabled) {
            background: var(--rec-red);
            border-color: var(--rec-red);
            box-shadow: 0 0 20px rgba(255, 0, 64, 0.4);
        }
        .rec-button.recording {
            background: var(--rec-red);
            border-color: var(--rec-red);
            animation: recordPulse 2s ease-in-out infinite;
        }
        .rec-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        @keyframes recordPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 0, 64, 0.6); }
            50% { box-shadow: 0 0 30px rgba(255, 0, 64, 0.9); }
        }
        .rec-icon {
            width: 16px; height: 16px;
            background: currentColor;
            border-radius: 50%;
        }
        .rec-button.recording .rec-icon {
            border-radius: 3px;
        }
        .rec-info {
            display: flex; flex-direction: column;
            align-items: flex-end;
            font-size: 0.75rem;
            line-height: 1.2;
        }
        .rec-time {
            font-weight: 700;
            color: var(--rec-red);
        }
        .rec-size {
            color: var(--text-secondary);
        }

        /* CAST STATUS OVERLAY */
        .cast-status {
            position: absolute;
            top: 1rem; right: 1rem;
            background: rgba(0, 0, 0, 0.85);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--cast-blue);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 15;
            display: none;
        }
        .cast-status.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .cast-device-name {
            font-family: 'Syne', sans-serif;
            font-weight: 600;
            color: var(--cast-blue);
            margin-bottom: 0.25rem;
        }
        .cast-channel-name {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .video-wrapper { position: relative; width: 100%; padding-bottom: 56.25%; background: #000; }
        #videoPlayer, #iframePlayer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #iframePlayer { border: none; display: none; }
        #iframePlayer.active { display: block; }
        
        /* ZAPPING OVERLAY CONTROLS */
        .zap-controls {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 20; 
            display: flex; justify-content: space-between;
            align-items: center;
        }
        .zap-btn {
            width: 15%; 
            height: 60%;
            pointer-events: auto; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s; 
            background: rgba(0,0,0,0.1);
            border-radius: 16px;
        }
        .zap-btn:hover { opacity: 1; background: linear-gradient(90deg, rgba(0,0,0,0.5) 0%, transparent 100%); }
        .zap-btn.next:hover { background: linear-gradient(-90deg, rgba(0,0,0,0.5) 0%, transparent 100%); }
        .zap-btn svg { width: 40px; height: 40px; fill: white; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }

        .video-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0, 0, 0, 0.8); z-index: 10;
        }
        .video-overlay.hidden { display: none; }
        .select-prompt { text-align: center; padding: 2rem; }
        .select-prompt h3 { font-family: 'Syne', sans-serif; font-size: 2rem; margin-bottom: 1rem; }
        .select-prompt p { color: var(--text-secondary); font-size: 1.1rem; }

        /* Search & Filters */
        .search-box { width: 100%; position: relative; margin-bottom: 1rem; }
        .search-box input {
            width: 100%; padding: 1rem 1.5rem; background: var(--bg-secondary);
            border: 1px solid var(--border); border-radius: 16px;
            color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease;
        }
        .search-box input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        .category-filters { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .category-btn {
            padding: 0.6rem 1rem; background: var(--bg-secondary);
            border: 1px solid var(--border); border-radius: 10px;
            color: var(--text-secondary); font-size: 0.85rem; font-weight: 500;
            cursor: pointer; transition: all 0.3s ease; white-space: nowrap;
        }
        .category-btn.active { background: var(--accent); border-color: var(--accent); color: var(--bg-primary); font-weight: 600; }

        /* Channels Grid */
        .channels-grid { display: flex; flex-direction: column; gap: 0.75rem; }
        .channel-card {
            background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 12px;
            padding: 1rem; cursor: pointer; transition: all 0.2s ease;
            position: relative; overflow: hidden; display: flex; align-items: center; gap: 1rem;
        }
        .channel-card.focused, .channel-card:hover {
            border-color: var(--accent); transform: translateX(4px);
            box-shadow: 0 4px 20px var(--shadow); background: var(--bg-secondary);
        }
        .channel-card.active {
            border-color: var(--accent); background: linear-gradient(135deg, rgba(0, 217, 255, 0.15) 0%, var(--bg-tertiary) 100%);
            box-shadow: 0 0 20px var(--accent-glow);
        }
        .channel-card-content { position: relative; z-index: 1; display: flex; align-items: center; gap: 1rem; flex: 1; }
        .channel-card-logo {
            width: 50px; height: 50px; object-fit: contain;
            background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 0.5rem; flex-shrink: 0;
        }
        .channel-card-info { flex: 1; min-width: 0; }
        .channel-card h3 {
            font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 600;
            margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .channel-card-category { color: var(--text-secondary); font-size: 0.8rem; font-weight: 500; }

        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) {
            .sidebar { width: 100%; left: -100%; }
            .sidebar.open { left: 0; }
            .sidebar-toggle.open { left: calc(100% - 50px); }
            .main-content.shifted { margin-left: 0; }
            .container { padding: 1rem; }
            h1 { font-size: 2.5rem; }
            .player-header { flex-direction: column; gap: 1rem; align-items: flex-start; }
            .header-actions { width: 100%; justify-content: space-between; }
            .sidebar-filters { top: 195px; } /* Ajust√© pour 3 boutons */
            .zap-btn { opacity: 1; background: transparent; width: 20%; height: 50%; }
        }
        @media (min-width: 769px) and (max-width: 1024px) {
            .sidebar { width: 350px; left: -350px; }
            .sidebar-toggle.open { left: 350px; }
            .main-content.shifted { margin-left: 350px; }
        }

        .no-results { text-align: center; padding: 3rem 1rem; color: var(--text-secondary); }
        .sidebar::-webkit-scrollbar { width: 8px; }
        .sidebar::-webkit-scrollbar-track { background: var(--bg-primary); }
        .sidebar::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 4px; }
        .sidebar::-webkit-scrollbar-thumb:hover { background: var(--accent); }
        .loading-text { text-align: center; padding: 20px; color: var(--accent); font-family: 'Syne', sans-serif; }
    </style>
</head>
<body>
    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9 5l7 7-7 7"/></svg>
    </button>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <!-- TITRE CLIQUABLE POUR LE SECRET -->
            <div class="sidebar-title" onclick="unlockSecretMode()">TeslaTV</div>
            <div class="sidebar-subtitle">Chargement...</div>
            
            <div class="mode-switcher">
                <button class="mode-btn active" onclick="switchMode('tv')">Cha√Ænes TV</button>
                <button class="mode-btn" onclick="switchMode('series')">S√©ries</button>
                <!-- BOUTON CACH√â PAR D√âFAUT -->
                <button id="xxxBtn" class="mode-btn" onclick="switchMode('xxx')" style="display: none; color: #ff0040;">XXX (+18)</button>
            </div>
        </div>

        <div class="sidebar-filters">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Rechercher...">
            </div>
            <div class="category-filters" id="categoryFilters"></div>
        </div>

        <div class="sidebar-content">
            <div class="channels-grid" id="channelsGrid">
                <div class="loading-text">Chargement...</div>
            </div>
            <div class="no-results" id="noResults" style="display: none;">
                <h3>Aucun r√©sultat</h3>
                <p>Essayez une autre recherche</p>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="container">
            <header><h1>TeslaTv</h1></header>
            <div class="player-section">
                <div class="player-container">
                    <div class="player-header">
                        <div class="now-playing" id="nowPlaying">
                            <img src="https://i.imgur.com/QxHt9NC.png" alt="Logo" class="channel-logo" id="currentLogo">
                            <div class="channel-info">
                                <h2 id="currentChannel">S√©lectionnez un contenu</h2>
                                <div class="channel-category" id="currentCategory">-</div>
                            </div>
                        </div>
                        <div class="header-actions">
                            <div class="live-indicator" style="display: none;" id="liveIndicator">
                                <div class="live-dot"></div>
                                <div class="live-text">En Direct</div>
                            </div>
                            
                            <!-- Cast Button -->
                            <button class="cast-button disabled" id="castButton" onclick="toggleCast()">
                                <svg class="cast-icon" viewBox="0 0 24 24">
                                    <path d="M1 18v3h3c0-1.66-1.34-3-3-3zm0-4v2c2.76 0 5 2.24 5 5h2c0-3.87-3.13-7-7-7zm0-4v2c4.97 0 9 4.03 9 9h2c0-6.08-4.93-11-11-11zm20-7H3c-1.1 0-2 .9-2 2v3h2V5h18v14h-7v2h7c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
                                </svg>
                                <span id="castButtonText">Cast</span>
                            </button>
                            
                            <!-- Record Button -->
                            <button class="rec-button disabled" id="recButton" onclick="toggleRecording()">
                                <div class="rec-icon"></div>
                                <div class="rec-info">
                                    <span class="rec-time" id="recTime">00:00</span>
                                    <span class="rec-size" id="recSize">0 MB</span>
                                </div>
                            </button>
                        </div>
                    </div>
                    <div class="video-wrapper">
                        <!-- Cast Status Overlay -->
                        <div class="cast-status" id="castStatus">
                            <div class="cast-device-name" id="castDeviceName">Casting to...</div>
                            <div class="cast-channel-name" id="castChannelName">-</div>
                        </div>
                        
                        <div class="zap-controls">
                            <div class="zap-btn prev" onclick="zap(-1)">
                                <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                            </div>
                            <div class="zap-btn next" onclick="zap(1)">
                                <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                            </div>
                        </div>

                        <video id="videoPlayer" controls crossorigin="anonymous"></video>
                        <iframe id="iframePlayer" allowfullscreen allow="autoplay"></iframe>
                        <div class="video-overlay" id="videoOverlay">
                            <div class="select-prompt">
                                <h3>Bienvenue</h3>
                                <p>Appuyez sur "Entr√©e" ou le menu pour choisir</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const TV_URL = 'https://gist.githubusercontent.com/mikefri/0802a5afa97ac99a27cec4e6c1737a95/raw/channels.json';
        const SERIES_URL = 'https://gist.githubusercontent.com/mikefri/d914d7a8684d5f4900890bc41d9c223c/raw/series.json'; 
        const XXX_URL = 'https://gist.githubusercontent.com/mikefri/c4ea8003ac647eeafd14c35db59431ea/raw/3e53c48a0f2ee947439cea20bfa278dc7c7464e0/xx.json';

        let tvChannels = [];
        let seriesList = [];
        let xxxList = [];
        
        let currentMode = 'tv'; 
        let currentChannel = null;
        let currentPlayer = null;
        let activeCategory = 'Toutes';
        let filteredList = [];
        let focusedIndex = -1;

        // RECORDING VARIABLES
        let mediaRecorder = null;
        let recordedChunks = [];
        let recordingStartTime = null;
        let recordingInterval = null;

        // CAST VARIABLES
        let castSession = null;
        let castContext = null;
        let remotePlayer = null;
        let remotePlayerController = null;

        const USE_PROXY = window.location.hostname.includes('github.io');
        const CORS_PROXIES = ['https://corsproxy.io/?', 'https://api.allorigins.win/raw?url='];
        let currentProxyIndex = 0;
        
        function getProxiedUrl(url) {
            if (!USE_PROXY || url.includes('rereyano.ru') || url.includes('akamaized.net') || url.includes('cloudfront.net') || url.includes('amagi.tv')) return url;
            return CORS_PROXIES[currentProxyIndex] + encodeURIComponent(url);
        }

        // --- CAST INITIALIZATION ---
        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                initializeCastApi();
            }
        };

        function initializeCastApi() {
            try {
                castContext = cast.framework.CastContext.getInstance();
                castContext.setOptions({
                    receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                });

                remotePlayer = new cast.framework.RemotePlayer();
                remotePlayerController = new cast.framework.RemotePlayerController(remotePlayer);

                castContext.addEventListener(
                    cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                    onCastSessionChanged
                );

                remotePlayerController.addEventListener(
                    cast.framework.RemotePlayerEventType.IS_CONNECTED_CHANGED,
                    onCastConnectionChanged
                );

                document.getElementById('castButton').classList.remove('disabled');
                console.log('‚úÖ Google Cast initialized');
            } catch (error) {
                console.error('‚ùå Cast initialization failed:', error);
            }
        }

        function onCastSessionChanged(event) {
            switch (event.sessionState) {
                case cast.framework.SessionState.SESSION_STARTED:
                case cast.framework.SessionState.SESSION_RESUMED:
                    castSession = castContext.getCurrentSession();
                    updateCastButton(true);
                    if (currentChannel) {
                        loadMediaToCast(currentChannel);
                    }
                    break;
                case cast.framework.SessionState.SESSION_ENDED:
                    castSession = null;
                    updateCastButton(false);
                    document.getElementById('castStatus').classList.remove('active');
                    break;
            }
        }

        function onCastConnectionChanged() {
            if (remotePlayer.isConnected) {
                console.log('‚úÖ Connected to:', remotePlayer.friendlyName);
            }
        }

        function toggleCast() {
            const castButton = document.getElementById('castButton');
            if (castButton.classList.contains('disabled')) return;

            if (castSession) {
                castContext.endCurrentSession(true);
            } else {
                castContext.requestSession().then(
                    () => console.log('Cast session started'),
                    error => {
                        if (error !== 'cancel') console.error('Cast error:', error);
                    }
                );
            }
        }

        function updateCastButton(isCasting) {
            const castButton = document.getElementById('castButton');
            const castButtonText = document.getElementById('castButtonText');
            
            if (isCasting) {
                castButton.classList.add('casting');
                castButtonText.textContent = 'Casting';
            } else {
                castButton.classList.remove('casting');
                castButtonText.textContent = 'Cast';
            }
        }

        function loadMediaToCast(channel) {
            if (!castSession) return;

            const mediaInfo = new chrome.cast.media.MediaInfo(channel.url, 'video/mp4');
            mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
            mediaInfo.metadata.metadataType = chrome.cast.media.MetadataType.GENERIC;
            mediaInfo.metadata.title = channel.name;
            mediaInfo.metadata.subtitle = channel.category;
            
            if (channel.logo) {
                mediaInfo.metadata.images = [new chrome.cast.Image(channel.logo)];
            }

            const request = new chrome.cast.media.LoadRequest(mediaInfo);
            request.autoplay = true;

            castSession.loadMedia(request).then(
                () => {
                    console.log('‚úÖ Media loaded to cast');
                    document.getElementById('castStatus').classList.add('active');
                    document.getElementById('castDeviceName').textContent = `Casting to ${castSession.getSessionObj().receiver.friendlyName}`;
                    document.getElementById('castChannelName').textContent = channel.name;
                },
                error => console.error('‚ùå Cast load error:', error)
            );
        }

        async function init() {
            await loadContent('tv');
            document.addEventListener('keydown', handleRemoteControl);
            
            const video = document.getElementById('videoPlayer');
            if (window.WebKitPlaybackTargetAvailabilityEvent) {
                video.addEventListener('webkitplaybacktargetavailabilitychanged', (event) => {
                    if (event.availability === 'available') console.log('‚úÖ AirPlay available');
                });
            }
        }

        // --- RECORDING FUNCTIONS ---
        async function toggleRecording() {
            const recButton = document.getElementById('recButton');
            if (recButton.classList.contains('disabled')) return;
            
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            const video = document.getElementById('videoPlayer');
            const recButton = document.getElementById('recButton');
            
            try {
                const stream = video.captureStream ? video.captureStream() : video.mozCaptureStream();
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp9,opus',
                    videoBitsPerSecond: 2500000
                });
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) recordedChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => downloadRecording();
                
                mediaRecorder.start(1000);
                recordingStartTime = Date.now();
                recButton.classList.add('recording');
                
                recordingInterval = setInterval(updateRecordingInfo, 1000);
                updateRecordingInfo();
            } catch (error) {
                console.error('Recording error:', error);
                alert('Erreur: impossible de d√©marrer l\'enregistrement.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                clearInterval(recordingInterval);
                document.getElementById('recButton').classList.remove('recording');
            }
        }

        function updateRecordingInfo() {
            if (!recordingStartTime) return;
            
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            document.getElementById('recTime').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            const estimatedMB = (elapsed * 0.3125).toFixed(1);
            document.getElementById('recSize').textContent = `${estimatedMB} MB`;
        }

        function downloadRecording() {
            if (recordedChunks.length === 0) return;
            
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            const channelName = currentChannel ? currentChannel.name.replace(/[^a-z0-9]/gi, '_') : 'recording';
            const timestamp = new Date().toISOString().replace(/:/g, '-').split('.')[0];
            a.href = url;
            a.download = `TeslaTV_${channelName}_${timestamp}.webm`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            recordedChunks = [];
            recordingStartTime = null;
            
            document.getElementById('recTime').textContent = '00:00';
            document.getElementById('recSize').textContent = '0 MB';
        }

        // --- REMOTE CONTROL ---
        function handleRemoteControl(e) {
            const sidebar = document.getElementById('sidebar');
            const isSidebarOpen = sidebar.classList.contains('open');

            if (e.key === 'r' || e.key === 'R') { e.preventDefault(); toggleRecording(); return; }
            if (e.key === 'c' || e.key === 'C') { e.preventDefault(); toggleCast(); return; }

            if (isSidebarOpen) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    focusedIndex = Math.min(focusedIndex + 1, filteredList.length - 1);
                    updateFocus();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    focusedIndex = Math.max(focusedIndex - 1, 0);
                    updateFocus();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (focusedIndex >= 0 && filteredList[focusedIndex]) {
                        playChannel(filteredList[focusedIndex].id);
                    }
                } else if (e.key === 'Escape' || e.key === 'Backspace' || e.key === 'ArrowRight') {
                    closeSidebar();
                }
            } else {
                if (e.key === 'ArrowRight') zap(1);
                else if (e.key === 'ArrowLeft') zap(-1);
                else if (e.key === 'Enter' || e.key === 'ArrowUp') toggleSidebar();
            }
        }

        function updateFocus() {
            document.querySelectorAll('.channel-card').forEach(c => c.classList.remove('focused'));
            const cards = document.querySelectorAll('.channel-card');
            if (cards[focusedIndex]) {
                cards[focusedIndex].classList.add('focused');
                cards[focusedIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function zap(direction) {
            if (!currentChannel || filteredList.length === 0) return;
            const currentIndex = filteredList.findIndex(ch => ch.id === currentChannel.id);
            if (currentIndex === -1) return;
            let newIndex = currentIndex + direction;
            if (newIndex >= filteredList.length) newIndex = 0;
            if (newIndex < 0) newIndex = filteredList.length - 1;
            playChannel(filteredList[newIndex].id);
        }

        async function switchMode(mode) {
            // Check based on mode
            let listLength = 0;
            if (mode === 'tv') listLength = tvChannels.length;
            else if (mode === 'series') listLength = seriesList.length;
            else if (mode === 'xxx') listLength = xxxList.length;

            if (currentMode === mode && listLength > 0) return;
            
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                stopRecording();
            }
            
            currentMode = mode;
            activeCategory = 'Toutes';
            focusedIndex = -1;
            
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            // Use specific selector to target buttons even if hidden
            document.querySelector(`.mode-btn[onclick="switchMode('${mode}')"]`).classList.add('active');
            
            document.getElementById('channelsGrid').innerHTML = '<div class="loading-text">Chargement...</div>';
            document.getElementById('categoryFilters').innerHTML = '';
            
            await loadContent(mode);
        }

        async function loadContent(mode) {
            let url;
            let data;
            
            // Map mode to URL and Variable
            if (mode === 'tv') { url = TV_URL; data = tvChannels; }
            else if (mode === 'series') { url = SERIES_URL; data = seriesList; }
            else { url = XXX_URL; data = xxxList; }
            
            try {
                if (data.length === 0) {
                    const response = await fetch(url + '?t=' + new Date().getTime());
                    if (!response.ok) throw new Error('Erreur r√©seau');
                    data = await response.json();
                    
                    if (mode === 'tv') tvChannels = data;
                    else if (mode === 'series') seriesList = data;
                    else xxxList = data;
                }
                updateUI(data);
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('channelsGrid').innerHTML = `<div class="no-results" style="display:block"><h3>Erreur</h3><p>Impossible de charger.</p></div>`;
                document.querySelector('.sidebar-subtitle').textContent = `0 contenu`;
            }
        }

        function updateUI(data) {
            let typeLabel = 'contenus';
            if (currentMode === 'tv') typeLabel = 'cha√Ænes';
            else if (currentMode === 'series') typeLabel = 's√©ries';
            else typeLabel = 'vid√©os';

            document.querySelector('.sidebar-subtitle').textContent = `${data.length} ${typeLabel}`;
            const categories = ['Toutes', ...new Set(data.map(ch => ch.category))];
            const filterContainer = document.getElementById('categoryFilters');
            filterContainer.innerHTML = categories.map(cat => `
                <button class="category-btn ${cat === activeCategory ? 'active' : ''}" onclick="filterByCategory('${cat}')">${cat}</button>
            `).join('');
            applyFilters();
        }

        function filterByCategory(category) {
            activeCategory = category;
            focusedIndex = -1;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === category);
            });
            applyFilters();
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const grid = document.getElementById('channelsGrid');
            const noResults = document.getElementById('noResults');
            
            let currentData;
            if (currentMode === 'tv') currentData = tvChannels;
            else if (currentMode === 'series') currentData = seriesList;
            else currentData = xxxList;

            filteredList = currentData.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm);
                const matchesCategory = activeCategory === 'Toutes' || item.category === activeCategory;
                return matchesSearch && matchesCategory;
            });
            
            if (filteredList.length === 0) {
                grid.style.display = 'none';
                noResults.style.display = 'block';
            } else {
                grid.style.display = 'flex';
                noResults.style.display = 'none';
                grid.innerHTML = filteredList.map((item, index) => `
                    <div class="channel-card ${currentChannel?.id === item.id ? 'active' : ''}" onclick="playChannel(${item.id})">
                        <div class="channel-card-content">
                            <img src="${item.logo || 'https://i.imgur.com/QxHt9NC.png'}" class="channel-card-logo" onerror="this.src='https://i.imgur.com/QxHt9NC.png'">
                            <div class="channel-card-info">
                                <h3>${item.name}</h3>
                                <div class="channel-card-category">${item.category}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function playChannel(id) {
            const item = filteredList.find(ch => ch.id === id);
            if (!item) return;
            
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                stopRecording();
            }
            
            currentChannel = item;
            document.getElementById('currentChannel').textContent = item.name;
            document.getElementById('currentCategory').textContent = item.category;
            const logoEl = document.getElementById('currentLogo');
            logoEl.src = item.logo || 'https://i.imgur.com/QxHt9NC.png';
            document.getElementById('liveIndicator').style.display = currentMode === 'tv' ? 'flex' : 'none';
            document.getElementById('videoOverlay').classList.add('hidden');
            
            applyFilters();
            loadVideo(item.url);
            
            if (castSession) loadMediaToCast(item);
            if (window.innerWidth <= 768) closeSidebar();
        }

        function loadVideo(url) {
            const video = document.getElementById('videoPlayer');
            const iframe = document.getElementById('iframePlayer');
            const recButton = document.getElementById('recButton');
            
            if (currentPlayer && currentPlayer.destroy) { currentPlayer.destroy(); currentPlayer = null; }
            
            const isWebPlayer = url.includes('rereyano.ru') || (!url.endsWith('.mpd') && !url.endsWith('.m3u8') && url.includes('/player/'));
            
            if (isWebPlayer) {
                video.style.display = 'none';
                iframe.classList.add('active');
                iframe.src = url;
                recButton.classList.add('disabled');
            } else {
                iframe.classList.remove('active');
                iframe.src = '';
                video.style.display = 'block';
                recButton.classList.remove('disabled');
                
                const streamUrl = getProxiedUrl(url);
                if (url.endsWith('.mpd')) {
                    if (typeof dashjs !== 'undefined') {
                        currentPlayer = dashjs.MediaPlayer().create();
                        currentPlayer.initialize(video, streamUrl, true);
                        currentPlayer.on('error', (e) => { if (e.error === 'download' && USE_PROXY) retryProxy(url); });
                    }
                } else if (url.endsWith('.m3u8')) {
                    if (Hls.isSupported()) {
                        currentPlayer = new Hls({ enableWorker: true, lowLatencyMode: true });
                        currentPlayer.loadSource(streamUrl);
                        currentPlayer.attachMedia(video);
                        currentPlayer.on(Hls.Events.MANIFEST_PARSED, () => video.play());
                        currentPlayer.on(Hls.Events.ERROR, (e, data) => { if (data.fatal && USE_PROXY) retryProxy(url); });
                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                        video.src = streamUrl;
                        video.play();
                    }
                } else {
                    video.src = streamUrl;
                    video.play();
                }
            }
        }

        function retryProxy(url) {
            currentProxyIndex = (currentProxyIndex + 1) % CORS_PROXIES.length;
            setTimeout(() => loadVideo(url), 1000);
        }

        document.getElementById('searchInput').addEventListener('input', applyFilters);
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar.classList.contains('open')) { focusedIndex = 0; updateFocus(); }
            sidebar.classList.toggle('open');
            document.getElementById('sidebarToggle').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('active');
            if (window.innerWidth > 768) document.getElementById('mainContent').classList.toggle('shifted');
        }
        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarToggle').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('active');
            document.getElementById('mainContent').classList.remove('shifted');
        }

        // --- LOGIQUE DU MODE SECRET ---
        let secretClickCount = 0;
        let secretTimeout;

        function unlockSecretMode() {
            secretClickCount++;
            
            // Reset du compteur si l'utilisateur arr√™te de cliquer pendant 2 secondes
            clearTimeout(secretTimeout);
            secretTimeout = setTimeout(() => {
                secretClickCount = 0;
            }, 2000);

            // Au 5√®me clic
            if (secretClickCount >= 5) {
                const btn = document.getElementById('xxxBtn');
                const isHidden = btn.style.display === 'none';
                
                if (isHidden) {
                    btn.style.display = 'block';
                    alert('üîû Mode Adulte D√©verrouill√©');
                } else {
                    btn.style.display = 'none';
                    if (currentMode === 'xxx') {
                        switchMode('tv'); // Retour en mode TV si on √©tait sur XXX
                    }
                    alert('üîí Mode Adulte Verrouill√©');
                }
                secretClickCount = 0;
            }
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
