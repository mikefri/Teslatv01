<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeslaTV - Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #151b2b;
            --bg-tertiary: #1e2738;
            --accent: #00d9ff;
            --accent-glow: rgba(0, 217, 255, 0.3);
            --text-primary: #ffffff;
            --text-secondary: #8b93a7;
            --border: rgba(255, 255, 255, 0.08);
            --shadow: rgba(0, 0, 0, 0.4);
            --rec-red: #ff0040;
            --cast-blue: #4285f4;
            --fav-gold: #ffb700;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }

        /* --- UI ELEMENTS --- */
        .sidebar-toggle {
            position: fixed; left: 0; top: 50%; transform: translateY(-50%);
            width: 40px; height: 100px;
            background: var(--bg-tertiary); border: 1px solid var(--border);
            border-left: none; border-radius: 0 12px 12px 0; cursor: pointer; z-index: 1001;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease; box-shadow: 4px 0 15px rgba(0,0,0,0.3);
        }
        .sidebar-toggle:hover { background: var(--accent); color: var(--bg-primary); }
        .sidebar-toggle.open { left: 450px; }
        .sidebar-toggle svg { width: 24px; height: 24px; fill: currentColor; }

        .sidebar {
            position: fixed; left: -450px; top: 0;
            width: 450px; height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            z-index: 1000;
            transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
        }
        .sidebar.open { left: 0; }

        .sidebar-header {
            padding: 1.5rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .sidebar-title {
            font-family: 'Syne', sans-serif; font-size: 1.8rem; font-weight: 800;
            background: linear-gradient(90deg, #fff, var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            cursor: pointer; user-select: none;
        }

        .mode-switcher {
            display: flex; background: var(--bg-primary); padding: 4px;
            border-radius: 10px; margin-top: 1rem; border: 1px solid var(--border);
        }
        .mode-btn {
            flex: 1; padding: 8px; border: none; background: transparent;
            color: var(--text-secondary); cursor: pointer; border-radius: 6px;
            font-weight: 600; font-size: 0.85rem; transition: 0.2s;
        }
        .mode-btn.active { background: var(--bg-tertiary); color: var(--text-primary); }

        .sidebar-filters { padding: 1rem; background: var(--bg-secondary); border-bottom: 1px solid var(--border); }
        
        .search-box input {
            width: 100%; padding: 0.8rem 1rem; background: var(--bg-primary);
            border: 1px solid var(--border); border-radius: 8px;
            color: white; outline: none; transition: 0.3s;
        }
        .search-box input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }

        .category-filters {
            display: flex; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.5rem; margin-top: 0.8rem;
            scrollbar-width: thin; scrollbar-color: var(--bg-tertiary) transparent;
        }
        .category-btn {
            padding: 0.4rem 0.8rem; background: var(--bg-primary); border: 1px solid var(--border);
            border-radius: 20px; color: var(--text-secondary); white-space: nowrap; cursor: pointer;
            font-size: 0.8rem;
        }
        .category-btn.active { background: var(--accent); color: var(--bg-primary); border-color: var(--accent); font-weight: 700; }

        .sidebar-content { flex: 1; overflow-y: auto; padding: 1rem; }
        .channel-card {
            display: flex; align-items: center; gap: 1rem; padding: 0.8rem;
            background: var(--bg-tertiary); border: 1px solid var(--border);
            border-radius: 12px; margin-bottom: 0.8rem; cursor: pointer;
            transition: 0.2s; position: relative;
        }
        .channel-card:hover { transform: translateY(-2px); border-color: var(--text-secondary); }
        .channel-card.active { border-color: var(--accent); background: linear-gradient(90deg, rgba(0,217,255,0.1), transparent); }
        
        .channel-logo { width: 40px; height: 40px; object-fit: contain; background: rgba(255,255,255,0.05); border-radius: 8px; padding: 4px; }
        .channel-info h3 { font-size: 0.95rem; font-weight: 600; margin-bottom: 2px; }
        .channel-info span { font-size: 0.75rem; color: var(--text-secondary); }
        
        /* Favorite Star in Card */
        .fav-icon {
            margin-left: auto; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary); transition: 0.2s; opacity: 0.5; z-index: 2;
        }
        .fav-icon:hover { opacity: 1; transform: scale(1.2); }
        .fav-icon.is-fav { color: var(--fav-gold); opacity: 1; }
        .fav-icon svg { width: 18px; height: 18px; fill: currentColor; }

        /* --- PLAYER AREA --- */
        .main-content { transition: margin-left 0.4s; height: 100vh; display: flex; flex-direction: column; }
        .main-content.shifted { margin-left: 450px; }
        
        .container { flex: 1; display: flex; flex-direction: column; padding: 2rem; max-width: 1600px; margin: 0 auto; width: 100%; }
        
        .player-container {
            background: #000; border-radius: 24px; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6); border: 1px solid var(--border);
            display: flex; flex-direction: column;
        }

        .player-header {
            padding: 1rem 2rem; background: var(--bg-secondary);
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .current-logo { width: 40px; height: 40px; object-fit: contain; }
        
        .controls-right { display: flex; gap: 0.8rem; }
        .action-btn {
            background: var(--bg-tertiary); border: 1px solid var(--border); color: white;
            width: 40px; height: 40px; border-radius: 10px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .action-btn:hover { background: var(--accent); color: var(--bg-primary); }
        .action-btn svg { width: 20px; height: 20px; fill: currentColor; }
        
        .video-wrapper { position: relative; padding-bottom: 56.25%; background: #000; }
        #videoPlayer, #iframePlayer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #iframePlayer { display: none; border: 0; }
        #iframePlayer.active { display: block; }

        /* LOADING SPINNER */
        .loader-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
            z-index: 5; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .loader-overlay.active { opacity: 1; }
        .spinner {
            width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1);
            border-left-color: var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Select Overlay */
        .select-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 4;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .select-overlay h2 { font-family: 'Syne', sans-serif; font-size: 2.5rem; margin-bottom: 1rem; color: var(--accent); }
        .select-overlay p { color: var(--text-secondary); }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { width: 100%; }
            .sidebar-toggle.open { left: auto; right: 0; border-radius: 12px 0 0 12px; }
            .main-content.shifted { margin-left: 0; }
            .container { padding: 1rem; }
            .player-header { padding: 1rem; }
            .channel-info h3 { font-size: 0.9rem; }
        }
    </style>
</head>
<body>

    <!-- SIDEBAR TOGGLE -->
    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
        <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
    </button>

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title" onclick="unlockSecretMode()">TeslaTV <span style="font-size:0.8rem; color:var(--text-secondary)">v2.0</span></div>
            
            <div class="mode-switcher">
                <button class="mode-btn active" onclick="switchMode('tv')">TV</button>
                <button class="mode-btn" onclick="switchMode('series')">S√©ries</button>
                <button id="xxxBtn" class="mode-btn" onclick="switchMode('xxx')" style="display: none; color: var(--rec-red);">XXX</button>
            </div>
        </div>

        <div class="sidebar-filters">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Rechercher une cha√Æne...">
            </div>
            <div class="category-filters" id="categoryFilters">
                <!-- Filters injected via JS -->
            </div>
        </div>

        <div class="sidebar-content" id="channelsGrid">
            <!-- Channels injected via JS -->
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content" id="mainContent">
        <div class="container">
            <div class="player-container">
                <div class="player-header">
                    <div class="header-left">
                        <img src="" id="playerLogo" class="current-logo" style="display: none;">
                        <div>
                            <h2 id="playerTitle" style="font-size: 1.2rem; font-weight:700;">Bienvenue</h2>
                            <p id="playerSub" style="font-size: 0.8rem; color: var(--text-secondary);">S√©lectionnez un contenu</p>
                        </div>
                    </div>
                    <div class="controls-right">
                        <!-- Favorites Toggle (Current Channel) -->
                        <button class="action-btn" onclick="toggleCurrentFav()" title="Ajouter aux favoris">
                            <svg viewBox="0 0 24 24" id="currentFavIcon"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        </button>
                        <!-- PiP Button -->
                        <button class="action-btn" onclick="togglePiP()" title="Picture in Picture">
                            <svg viewBox="0 0 24 24"><path d="M19 11h-8v6h8v-6zm4 8V4.98C23 3.88 22.1 3 21 3H3c-1.1 0-2 .88-2 1.98V19c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2zm-2 .02H3V4.97h18v14.05z"/></svg>
                        </button>
                        <!-- Cast Button -->
                        <button class="action-btn" onclick="toggleCast()" id="castBtn" title="Caster sur TV">
                            <svg viewBox="0 0 24 24"><path d="M1 18v3h3c0-1.66-1.34-3-3-3zm0-4v2c2.76 0 5 2.24 5 5h2c0-3.87-3.13-7-7-7zm0-4v2c4.97 0 9 4.03 9 9h2c0-6.08-4.93-11-11-11zm20-7H3c-1.1 0-2 .9-2 2v3h2V5h18v14h-7v2h7c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
                        </button>
                    </div>
                </div>

                <div class="video-wrapper">
                    <div class="loader-overlay" id="loader">
                        <div class="spinner"></div>
                    </div>
                    
                    <div class="select-overlay" id="startOverlay">
                        <h2>TeslaTV</h2>
                        <p>Ouvrez le menu pour commencer</p>
                    </div>

                    <video id="videoPlayer" controls autoplay playsinline crossorigin="anonymous"></video>
                    <iframe id="iframePlayer" allowfullscreen allow="autoplay"></iframe>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const SOURCES = {
            tv: 'https://gist.githubusercontent.com/mikefri/0802a5afa97ac99a27cec4e6c1737a95/raw/channels.json',
            series: 'https://gist.githubusercontent.com/mikefri/d914d7a8684d5f4900890bc41d9c223c/raw/series.json',
            xxx: 'https://gist.githubusercontent.com/mikefri/c4ea8003ac647eeafd14c35db59431ea/raw/xx.json'
        };

        // STATE
        let state = {
            mode: localStorage.getItem('lastMode') || 'tv',
            data: [],
            currentChannel: null,
            favorites: JSON.parse(localStorage.getItem('teslaTvFavs')) || [],
            filter: 'Toutes'
        };

        let player = null; // Dash/HLS instance
        
        // DOM ELEMENTS
        const els = {
            sidebar: document.getElementById('sidebar'),
            grid: document.getElementById('channelsGrid'),
            video: document.getElementById('videoPlayer'),
            iframe: document.getElementById('iframePlayer'),
            loader: document.getElementById('loader'),
            overlay: document.getElementById('startOverlay'),
            search: document.getElementById('searchInput')
        };

        // --- INIT ---
        async function init() {
            // Restore UI state
            switchMode(state.mode);
            
            // Listeners
            els.search.addEventListener('input', renderList);
            els.video.addEventListener('waiting', () => els.loader.classList.add('active'));
            els.video.addEventListener('playing', () => els.loader.classList.remove('active'));
            els.video.addEventListener('canplay', () => els.loader.classList.remove('active'));

            // Auto-open sidebar if on desktop
            if (window.innerWidth > 1000) toggleSidebar();
        }

        // --- LOGIC ---

        async function switchMode(mode) {
            state.mode = mode;
            state.filter = 'Toutes';
            localStorage.setItem('lastMode', mode);
            
            // UI Update
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.mode-btn[onclick="switchMode('${mode}')"]`)?.classList.add('active');
            
            // Load Data
            els.grid.innerHTML = '<div style="text-align:center; padding:2rem;">Chargement...</div>';
            
            try {
                // Check cache logic here if needed, simplified fetch:
                const res = await fetch(SOURCES[mode] + '?t=' + Date.now());
                state.data = await res.json();
                generateCategories();
                renderList();
            } catch (e) {
                els.grid.innerHTML = '<div style="text-align:center; color:red">Erreur de chargement</div>';
            }
        }

        function generateCategories() {
            const cats = ['Toutes', '‚ù§Ô∏è Favoris', ...new Set(state.data.map(i => i.category))];
            const container = document.getElementById('categoryFilters');
            container.innerHTML = cats.map(c => 
                `<button class="category-btn ${c === state.filter ? 'active' : ''}" onclick="setFilter('${c}')">${c}</button>`
            ).join('');
        }

        function setFilter(cat) {
            state.filter = cat;
            generateCategories();
            renderList();
        }

        function renderList() {
            const search = els.search.value.toLowerCase();
            let filtered = state.data.filter(item => item.name.toLowerCase().includes(search));

            if (state.filter === '‚ù§Ô∏è Favoris') {
                filtered = filtered.filter(item => state.favorites.includes(item.id));
            } else if (state.filter !== 'Toutes') {
                filtered = filtered.filter(item => item.category === state.filter);
            }

            els.grid.innerHTML = filtered.map(item => {
                const isFav = state.favorites.includes(item.id);
                const isActive = state.currentChannel && state.currentChannel.id === item.id;
                
                return `
                <div class="channel-card ${isActive ? 'active' : ''}" onclick="play(${item.id})">
                    <img src="${item.logo || 'https://i.imgur.com/QxHt9NC.png'}" class="channel-logo" loading="lazy">
                    <div class="channel-info">
                        <h3>${item.name}</h3>
                        <span>${item.category}</span>
                    </div>
                    <div class="fav-icon ${isFav ? 'is-fav' : ''}" onclick="toggleFav(event, ${item.id})">
                        <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                    </div>
                </div>
                `;
            }).join('') || '<div style="text-align:center; padding:1rem; opacity:0.5">Aucun r√©sultat</div>';
        }

        // --- PLAYBACK ---

        function play(id) {
            const item = state.data.find(i => i.id === id);
            if (!item) return;

            state.currentChannel = item;
            renderList(); // Update active state

            // Update Header
            document.getElementById('playerTitle').textContent = item.name;
            document.getElementById('playerSub').textContent = item.category;
            const logo = document.getElementById('playerLogo');
            logo.src = item.logo || '';
            logo.style.display = 'block';
            updateFavBtnIcon();

            // Hide Overlay
            els.overlay.style.display = 'none';
            els.loader.classList.add('active');

            // Reset Players
            if (player) { try { player.destroy(); } catch(e){} player = null; }
            els.video.style.display = 'none';
            els.iframe.style.display = 'none';
            els.iframe.src = '';
            els.video.pause();
            els.video.removeAttribute('src');

            const url = item.url;

            // 1. MEGA / IFRAME
            if (url.includes('mega.nz') || url.includes('iframe') || !url.match(/\.(m3u8|mpd|mp4)$/)) {
                let finalUrl = url;
                if(url.includes('mega.nz')) finalUrl = url.replace('/file/', '/embed/');
                els.iframe.src = finalUrl;
                els.iframe.classList.add('active');
                els.iframe.style.display = 'block';
                els.loader.classList.remove('active'); // Iframe loads internally
                return;
            }

            // 2. VIDEO STREAM
            els.video.style.display = 'block';
            
            // Proxy logic could go here
            const streamUrl = url; 

            if (url.endsWith('.m3u8')) {
                if (Hls.isSupported()) {
                    player = new Hls();
                    player.loadSource(streamUrl);
                    player.attachMedia(els.video);
                    player.on(Hls.Events.MANIFEST_PARSED, () => els.video.play());
                } else if (els.video.canPlayType('application/vnd.apple.mpegurl')) {
                    els.video.src = streamUrl;
                    els.video.play();
                }
            } else if (url.endsWith('.mpd')) {
                player = dashjs.MediaPlayer().create();
                player.initialize(els.video, streamUrl, true);
            } else {
                els.video.src = streamUrl;
                els.video.play();
            }

            // Close sidebar on mobile
            if(window.innerWidth < 768) toggleSidebar();
        }

        // --- FEATURES ---

        function toggleSidebar() {
            els.sidebar.classList.toggle('open');
            document.getElementById('sidebarToggle').classList.toggle('open');
            if(window.innerWidth > 768) document.getElementById('mainContent').classList.toggle('shifted');
        }

        function toggleFav(e, id) {
            e.stopPropagation();
            if (state.favorites.includes(id)) {
                state.favorites = state.favorites.filter(fid => fid !== id);
            } else {
                state.favorites.push(id);
            }
            localStorage.setItem('teslaTvFavs', JSON.stringify(state.favorites));
            renderList();
            if(state.currentChannel && state.currentChannel.id === id) updateFavBtnIcon();
        }

        function toggleCurrentFav() {
            if(state.currentChannel) toggleFav({stopPropagation:()=>{}}, state.currentChannel.id);
        }

        function updateFavBtnIcon() {
            const btn = document.getElementById('currentFavIcon');
            if(!state.currentChannel) return;
            const isFav = state.favorites.includes(state.currentChannel.id);
            btn.style.fill = isFav ? 'var(--fav-gold)' : 'currentColor';
        }

        function togglePiP() {
            if (document.pictureInPictureElement) {
                document.exitPictureInPicture();
            } else if (els.video.readyState === 4 || els.video.readyState === 3) {
                els.video.requestPictureInPicture();
            } else {
                alert("La vid√©o doit √™tre en lecture pour activer le PiP");
            }
        }
        
        // Secret Logic
        let secretCount = 0;
        function unlockSecretMode() {
            secretCount++;
            if (secretCount === 5) {
                document.getElementById('xxxBtn').style.display = 'block';
                alert("Mode d√©verrouill√© üîû");
            }
            setTimeout(() => secretCount = 0, 2000);
        }

        // --- CAST (Simplified) ---
        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                cast.framework.CastContext.getInstance().setOptions({
                    receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID
                });
            }
        };
        function toggleCast() {
            if(state.currentChannel && state.currentChannel.url.includes('mega.nz')) return alert("Cast impossible pour ce format");
            cast.framework.CastContext.getInstance().requestSession();
        }

        // Start
        init();

    </script>
</body>
</html>
